## CHART DA API-SERVIÇOS DE PRODUÇÃO
# Este projeto é voltado no CI/CD e operações rodando no ambiente do Kubernetes

image: harbor.unimednatal.com.br/api-servicos-prod/${DOCKER_USERNAME}/${APPLICATION_NAME}:${IMAGE_TAG}

stages:
    - clone
    - test
    - push

#clonando o repositório para dentro do host apartir de uma branch específica
clone:
    stage: clone
    tags:
        - chart-api-servicos
    only:
        - chart/api-servicos-prd
    script:
        - cd /home/unimed/projetos/helm-projects; rm -rf api-servicos
        - cd /home/unimed/projetos/helm-projects; git clone -b chart/api-servicos https://devopsunimed:glpat-PreJFT3SnriFSMAHFouu@gitlab.com/unimed_natal/helm-charts.git api-servicos
        
#antes de realizar deployment é feito testes nas estruturas do helm chart e dockerfile
test:
    stage: test
    tags:
        - chart-api-servicos
    only:
        - chart/api-servicos-prd
    script:
        - cd /home/unimed/projetos/helm-projects; helm unittest -f Chart.yaml -q api-servicos/
    needs: ["clone"]

push:
    stage: push
    tags:
        - chart-api-servicos
    only:
        - chart/api-servicos-prd
    script:
        - cd /home/unimed/projetos/helm-projects; helm package api-servicos
        - cd /home/unimed/projetos/helm-projects; helm push api_servicos-v0.16.tgz oci://harbor.unimednatal.com.br/api-servicos-prod
        - cd /home/unimed/projetos/helm-projects; rm api_servicos-v0.16.tgz
    needs: ["clone", "test"]